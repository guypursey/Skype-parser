<!doctype html>
<html>
<head>
<script src="/lib/jquery-1.8.3.js"></script>
<style type="text/css">
* {
	box-sizing: border-box;
	-moz-box-sizing: border-box;
	-webkit-box-sizing: border-box;
	margin: 0;
	padding: 0;
}
html, body {
	background-color: #000;
	color: #fff;
	height: 100%;
	width: 100%;
}
#interface {
	width: 50%;
	height: 100%;
	display: inline-block;
	float: left;
}
#results {
	width: 50%;
	height: 100%;
	display: inline-block;
	float: right;
}
table {
	font-family: 'Georgia';
}
td {
	vertical-align: top;
	padding: 5px;
	margin: 5px;
}
#convtitle {
	width: 80%;
	height: 10%;
}
#convparse {
	width: 10%;
	height: 10%;
}
#convinput {
	width: 100%;
	height: 90%;
}
#convjson {
	-moz-tab-size: 4;
	-o-tab-size: 4;
	-webkit-tab-size: 4;
	tab-size: 4;
}
#convoutput {
	width: 100%;
}
</style>
<script>
// version: 0.0.1

var CONV_DB = (function () {
	"use strict";
	var convLogs = [],
		createConversation = function () {
			var newConv = convLogs.length;
			convLogs[newConv] = (function (key) {
				var dateParsed,
					timeParsed,
					startDate,
					endDate,
					convName = key,
					origText, // the whole original text intact
					convLines = [], // the lines of the conversation split by line break
					convLog = [], // an array containing the logs of each line (date, time, text, author, etc) as objects
					changeName = function (name) {
						// TODO: check name exists, or assign it something
						convName = name;
					},
					parseText = function (text) {
						// TODO: it should be possible for the user to change these formats
						var dateTimeAuthRegExp = /\[[\d]+\/[\d]+\/\d\d\d\d\s[\d]+\:\d\d:\d\d[\s]*[\w]*\]\s[\w|\s|.]+:\s/,
							// assumes the date and time appear together in squared brackets followed by a space, author's name, a colon and a space 
							dateTimeRegExp = /\[[\d]+\/[\d]+\/\d\d\d\d\s[\d]+\:\d\d:\d\d[\s]*[\w]*\]/,
							// assumes date and time appear thus: [##/##/#### ##:##:##] possibly with an AM or PM on the end
							dateRegExp = /[\d]+\/[\d]+\/\d\d\d\d/,
							timeRegExp = /[\d]+\:\d\d:\d\d[\s]*[\w]*/,
							authRegExp = /\w[\w\w|\s|.]*:\s/,
							  // assumes authors name contains alphanumeric characters, spaces, and dots only and is followed by a colon and a space
							  // slightly different to the match contained above as we don't want the string to begin with a space
							  // therefore we assume that a username must start with an alphanumeric. after this it doesn't matter if we find more characters or not (an author's name could be just one letter long) so the + is a * here.
							dateTimeAuthObj,
							dateTimeObj, // variable for storing the object returned by a match
							dateStr = '',
							timeStr = '',
							authStr = '',
							textStr = '',
							i; // counter variable
							// TODO: check text exists and is the right type, or assign it something
							origText = text;
							convLines = text.split(/\n+(?=\[)/); // put each contribution to the conversation into an array
							//console.log(convLines);
							i = convLines.length;
						while (i) {
							i -= 1;
							textStr = convLines[i];
							dateStr = '';
							timeStr = '';
							authStr = '';
							/*
								needs to be a way to structure this with ternary conditional operators
								... or better still perhaps rethink the split by line break and do a split by date/time
							*/
							dateTimeAuthObj = convLines[i].match(dateTimeAuthRegExp);
							if (dateTimeAuthObj) {
								dateTimeObj = dateTimeAuthObj[0].match(dateTimeRegExp);
								// TODO: check index property of dateTimeStr object is 0
								if (dateTimeObj) {
									//console.log(dateTimeAuthObj[0]);
									dateStr = dateTimeObj[0].match(dateRegExp)[0];
									timeStr = dateTimeObj[0].match(timeRegExp)[0];
									//console.log(dateTimeObj[0], dateStr, timeStr);
								}
								authStr = dateTimeAuthObj[0].replace(/\[[\d]+\/[\d]+\/\d\d\d\d\s[\d]+\:\d\d:\d\d[\s]*[\w]*\]\s([\w|\s|.]+):\s/, '$1');
								//authStr = dateTimeAuthObj[0].match(authRegExp)[0];
								textStr = textStr.replace(dateTimeAuthObj[0], '');
								// removes date time and author leaving just the text the user typed
							}
							// TODO: should i make a local reference to this?
							// TODO: does making a local version make a copy or a pointer to the higher stacked version?
							convLog[i] = {
								'Date' : dateStr,
								'Time' : timeStr,
								'Author' : authStr,
								'Contribution' : textStr
							}; // does it need a closure?
						}
						return convLog;
					},
					getJSON = function () {
						return convLog; // TODO: will return an array -- but that's okay isn't it?
					};
				return {
					changeName: changeName,
					parseText: parseText,
					getJSON: getJSON
				};
			}(newConv));
			return convLogs[newConv];
		},
		retrieveConversation = function (convKey) {
			//console.log(convLogs);
			return convLogs[convKey];
		};
		return {
			createConversation: createConversation,
			retrieveConversation: retrieveConversation
		};
}());



/*
function parse() {
	var textEntryArea = document.getElementById('convinput');
	var textToParse = (textEntryArea) ? textEntryArea.innerHTML : '';
		
}
*/


window.onload = function () {
	"use strict";
	document.getElementById('convparse').onclick = function () {
		document.getElementById('convoutput').innerHTML = (function (convObj) {
			var str = "<table><tr>",
				i = (convObj) ? convObj.length : 0,
				convObj = (convObj) ? convObj.reverse() : [],
				prop;
			for (prop in convObj[0]) {
				str += (convObj[0].hasOwnProperty(prop)) ? "<td>" + prop + "</td>" : "";
			}
			str += "</tr>";
			while (i) {
				str += "<tr>";
				i -= 1;
				for (prop in convObj[i]) {
					str += (convObj[i].hasOwnProperty(prop)) ? "<td>" + convObj[i][prop] + "</td>" : "<td></td>";
					// TODO need to ensure there aren't any html tags in the text
				}
				str += "</tr>";
			}
			str += "</table>";
			return str;
		}(CONV_DB.createConversation().parseText(document.getElementById('convinput').value)));
		document.getElementById('convoutput-json').disabled=false;
	};
	
	document.getElementById('convoutput-json').onclick = function () {
		document.getElementById('convjson').innerHTML = JSON.stringify(CONV_DB.retrieveConversation(0).getJSON().reverse(), null, '\t');
	}

};

</script>
</head>
<body>
<div id="interface">
<input type="text" id="convtitle">
<input id="convparse" type="button" value="Parse">
<textarea id="convinput">
</textarea>
</div>
<div id="results">
<div class="convoutput-toolbar">
<input id="convoutput-json" type="button" value="Display as JSON" disabled="disabled">
</div>
<div id="pages">
<div id="loading" class="page">
Loading
</div>
<textarea id="convjson" readonly class="page tabbed">
</textarea>
<div id="convoutput" class="page tabbed">
</div>
</div>

</body>
</html>
